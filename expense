#! /usr/bin/env ruby

require 'pg'

 class CLI
  def initialize
    @app = ExpenseData.new
  end

  def run
    puts
    return display_help if ARGV.empty?

    command, *options = ARGV

    case command
    when 'list'
      @app.list_expenses
    when 'add'
      error_message = validate_new_expense(options)
      abort error_message if error_message

      @app.add_expense(*options)
      puts "The expense has been added."
    when 'search'
      error_message = validate_search(options)
      abort error_message if error_message

      @app.search_expenses(options)
    when 'delete'
      error_message = validate_id(options)
      abort error_message if error_message

      puts "The following expense has been deleted:"
      @app.delete_expense(options)
    end
  end

  def display_help
    puts <<~MENU
      An expense recording system

      Commands:

        add AMOUNT MEMO  record a new expense
        clear            delete all expenses
        list             list all expenses
        delete NUMBER    remove expense with id NUMBER
        search QUERY     list expenses with a matching QUERY field (use quotations for multi-word queries)
    MENU
  end

  def validate_new_expense(options)
    case options.size
    when (0...2)
      "You must provide an amount and memo."
    when (3...)
      "Memos with multiple words must be wrapped with quotation marks (\" \")."
    else
      if options.first.to_f <= 0
        "The amount must be entered first (as digits)."
      end
    end
  end

  def validate_search(query)
    case query.size
    when 0
      "You must provide a search query."
    when (2..)
      "Memos with multiple words must be wrapped with quotation marks (\" \")."
    end
  end

  def validate_id(id)
    case id.size
    when 0
      "You must provide an id."
    when (2..)
      "You must only provide an 'id' number."
    when 1
      id = id.first.to_i

      if id <= 0
        "You must provide a positive number." 
      elsif !@app.existing_ids.include?(id.to_s)
        "There is no expense with the id '#{id}'."
      end
    end
  end
end

 class ExpenseData
  def initialize
    @connection = PG.connect(dbname: 'expenses')
  end

  def list_expenses
    results = @connection.exec("SELECT * FROM expenses ORDER BY created_on;")
    display_expenses(results)
  end

  def add_expense(amount, memo)
    sql = "INSERT INTO expenses (amount, memo) VALUES ($1, $2);"
    @connection.exec_params(sql, [amount.to_f, memo])
  end

  def search_expenses(query)
    sql = "SELECT * FROM expenses WHERE memo ILIKE $1;"
    results = @connection.exec_params(sql, ['%' + query.first + '%'])
    display_expenses(results)
  end

  def delete_expense(id)
    results = @connection.exec("SELECT * FROM expenses WHERE id = #{id.first.to_i};")
    @connection.exec("DELETE FROM expenses WHERE id = #{id.first.to_i};")
    display_expenses(results)
  end

  def clear
    # delete all expenses
  end

  def display_expenses(table)
    # column name
    id, amount, memo, date = table.fields
    puts sprintf(' %-4s | %-20s | %-10s | %-s', id, date, amount, memo)
    puts "-" * 80
    # records
    table.each do |record|
      id, amount, memo, date = record.values
      puts sprintf(' %-4s | %-20s | %-10s | %-s', id, date, amount, memo)
    end
  end

  def existing_ids
    @connection.exec("SELECT id FROM expenses;").values.flatten
  end
 end

# program starts
CLI.new.run

